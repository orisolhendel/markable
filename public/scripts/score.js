const resTest = '{"request_id":"1691664925,5321d3c5-a57f-416c-8722-8c27e9970521","result":{"skin_age":{"value":52},"eye_pouch":{"value":0,"confidence":0.92295456},"dark_circle":{"value":2,"confidence":1},"dark_circle_severity":{"value":2,"confidence":1},"forehead_wrinkle":{"value":1,"confidence":0.89242446},"crows_feet":{"value":0,"confidence":0.8563155},"eye_finelines":{"value":1,"confidence":0.9452474},"eye_finelines_severity":{"value":2,"confidence":0.7296627},"glabella_wrinkle":{"value":0,"confidence":0.9223113},"nasolabial_fold":{"value":1,"confidence":0.807986},"nasolabial_fold_severity":{"value":1,"confidence":0.350535},"skin_type":{"skin_type":3,"details":[{"value":0,"confidence":0.07479176},{"value":0,"confidence":0.044511314},{"value":0,"confidence":0.051227324},{"value":1,"confidence":0.8294696}]},"pores_forehead":{"value":0,"confidence":1},"pores_left_cheek":{"value":0,"confidence":1},"pores_right_cheek":{"value":0,"confidence":1},"pores_jaw":{"value":0,"confidence":1},"blackhead":{"value":0,"confidence":1},"skintone_ita":{"ITA":27.979784,"skintone":3},"skin_hue_ha":{"HA":49.612156,"skin_hue":1},"acne":{"rectangle":[],"confidence":[],"polygon":[]},"mole":{"rectangle":[{"left":445,"top":387,"width":5,"height":5}],"confidence":[0.32407182],"polygon":[[]]},"brown_spot":{"rectangle":[{"left":367,"top":299,"width":6,"height":6},{"left":459,"top":195,"width":6,"height":6},{"left":450,"top":201,"width":5,"height":5},{"left":368,"top":475,"width":4,"height":5},{"left":418,"top":161,"width":9,"height":8},{"left":389,"top":446,"width":7,"height":5},{"left":533,"top":466,"width":5,"height":6},{"left":465,"top":498,"width":6,"height":6},{"left":557,"top":316,"width":4,"height":4},{"left":564,"top":275,"width":6,"height":6},{"left":440,"top":449,"width":5,"height":6},{"left":397,"top":486,"width":5,"height":5},{"left":431,"top":406,"width":8,"height":7},{"left":354,"top":430,"width":9,"height":7},{"left":384,"top":429,"width":7,"height":6},{"left":399,"top":463,"width":7,"height":6},{"left":437,"top":441,"width":6,"height":7},{"left":572,"top":447,"width":5,"height":6},{"left":519,"top":480,"width":4,"height":5},{"left":417,"top":489,"width":6,"height":7},{"left":462,"top":506,"width":6,"height":6},{"left":377,"top":446,"width":6,"height":4},{"left":368,"top":399,"width":4,"height":4},{"left":563,"top":265,"width":6,"height":4},{"left":382,"top":451,"width":6,"height":4},{"left":465,"top":148,"width":8,"height":8},{"left":541,"top":267,"width":5,"height":5},{"left":378,"top":293,"width":6,"height":6},{"left":521,"top":433,"width":4,"height":4},{"left":486,"top":450,"width":4,"height":5},{"left":570,"top":357,"width":4,"height":4},{"left":355,"top":424,"width":5,"height":4},{"left":503,"top":444,"width":6,"height":6},{"left":577,"top":336,"width":4,"height":4},{"left":364,"top":379,"width":10,"height":9},{"left":562,"top":291,"width":5,"height":6},{"left":419,"top":390,"width":5,"height":7},{"left":460,"top":491,"width":7,"height":8},{"left":390,"top":463,"width":8,"height":10},{"left":363,"top":459,"width":7,"height":6},{"left":359,"top":453,"width":6,"height":6},{"left":357,"top":407,"width":5,"height":7},{"left":361,"top":303,"width":4,"height":5},{"left":385,"top":304,"width":4,"height":5},{"left":454,"top":317,"width":8,"height":7}],"confidence":[0.5060489,0.5058997,0.5007537,0.49789065,0.48603842,0.47715205,0.47373915,0.46181908,0.44317916,0.4426912,0.4410696,0.42119867,0.4207796,0.4161441,0.41006923,0.37094206,0.3673297,0.3668791,0.36602154,0.36364657,0.36025175,0.35691905,0.35546732,0.34827623,0.34310836,0.33990932,0.33666757,0.33511943,0.33444464,0.33430132,0.33280602,0.33242285,0.33224374,0.32398927,0.32104838,0.32055688,0.31912985,0.31400004,0.3123598,0.31221426,0.3085555,0.30809617,0.30432716,0.30173752,0.30143332],"polygon":[[{"x":372,"y":302},{"x":369,"y":303},{"x":367,"y":299},{"x":372,"y":299}],[{"x":464,"y":198},{"x":461,"y":200},{"x":459,"y":197}],[],[],[{"x":425,"y":164},{"x":423,"y":167},{"x":418,"y":166},{"x":420,"y":163}],[],[],[{"x":469,"y":503},{"x":466,"y":500},{"x":468,"y":499}],[],[{"x":568,"y":277},{"x":564,"y":280},{"x":564,"y":277}],[],[],[{"x":437,"y":412},{"x":433,"y":408},{"x":438,"y":406}],[{"x":362,"y":434},{"x":358,"y":435},{"x":355,"y":432},{"x":361,"y":430}],[{"x":390,"y":434},{"x":386,"y":433},{"x":387,"y":430}],[{"x":405,"y":463},{"x":404,"y":467},{"x":400,"y":467}],[{"x":442,"y":446},{"x":438,"y":444},{"x":441,"y":442}],[],[],[{"x":422,"y":490},{"x":421,"y":494},{"x":417,"y":494}],[],[],[],[],[],[{"x":472,"y":149},{"x":470,"y":155},{"x":465,"y":155}],[],[{"x":383,"y":298},{"x":380,"y":294},{"x":383,"y":294}],[],[],[],[],[{"x":508,"y":448},{"x":504,"y":448},{"x":504,"y":445},{"x":508,"y":444}],[],[{"x":373,"y":387},{"x":365,"y":387},{"x":366,"y":382},{"x":373,"y":379}],[{"x":565,"y":291},{"x":566,"y":294},{"x":562,"y":294}],[{"x":423,"y":396},{"x":419,"y":396},{"x":420,"y":392}],[{"x":466,"y":497},{"x":460,"y":492},{"x":464,"y":492}],[{"x":397,"y":472},{"x":392,"y":471},{"x":391,"y":465},{"x":397,"y":463}],[{"x":369,"y":464},{"x":363,"y":461},{"x":366,"y":460}],[{"x":362,"y":458},{"x":360,"y":453},{"x":364,"y":455}],[{"x":359,"y":407},{"x":361,"y":409},{"x":358,"y":413}],[],[],[{"x":461,"y":320},{"x":458,"y":323},{"x":455,"y":321},{"x":459,"y":318}]]},"closed_comedones":{"rectangle":[],"confidence":[],"polygon":[]},"acne_mark":{"rectangle":[],"confidence":[],"polygon":[]},"acne_nodule":{"rectangle":[],"confidence":[],"polygon":[]},"acne_pustule":{"rectangle":[],"confidence":[],"polygon":[]},"blackhead_count":7,"skintone":{"value":2,"confidence":0.47396645},"fine_line":{"forehead_count":1,"left_undereye_count":1,"right_undereye_count":0,"left_cheek_count":0,"right_cheek_count":0,"left_crowsfeet_count":0,"right_crowsfeet_count":0,"glabella_count":0},"wrinkle_count":{"forehead_count":2,"left_undereye_count":2,"right_undereye_count":1,"left_mouth_count":0,"right_mouth_count":0,"left_nasolabial_count":1,"right_nasolabial_count":1,"glabella_count":0,"left_cheek_count":0,"right_cheek_count":0,"left_crowsfeet_count":1,"right_crowsfeet_count":1},"oily_intensity":{"t_zone":{"area":0.57,"intensity":2},"left_cheek":{"area":0.11,"intensity":0},"right_cheek":{"area":0.02,"intensity":0},"chin_area":{"area":0.04,"intensity":0}},"enlarged_pore_count":{"forehead_count":21,"left_cheek_count":19,"right_cheek_count":23,"chin_count":27},"right_dark_circle_rete":{"value":3},"left_dark_circle_rete":{"value":0},"right_dark_circle_pigment":{"value":0},"left_dark_circle_pigment":{"value":0},"right_dark_circle_structural":{"value":0},"left_dark_circle_structural":{"value":0},"dark_circle_mark":{"left_eye_rect":{"left":367,"top":260,"width":72,"height":62},"right_eye_rect":{"left":486,"top":264,"width":73,"height":64}},"water":{"water_severity":4,"water_area":0.04,"water_forehead":{"area":0.02},"water_leftcheek":{"area":0.068},"water_rightcheek":{"area":0.048}},"rough":{"rough_severity":15,"rough_area":0.225,"rough_forehead":{"area":0.251},"rough_leftcheek":{"area":0.205},"rough_rightcheek":{"area":0.206},"rough_jaw":{"area":0.196}},"left_mouth_wrinkle_severity":{"value":0},"right_mouth_wrinkle_severity":{"value":0},"forehead_wrinkle_severity":{"value":1},"left_crows_feet_severity":{"value":0},"right_crows_feet_severity":{"value":1},"left_eye_finelines_severity":{"value":0},"right_eye_finelines_severity":{"value":0},"glabella_wrinkle_severity":{"value":0},"left_nasolabial_fold_severity":{"value":2},"right_nasolabial_fold_severity":{"value":2},"left_cheek_wrinkle_severity":{"value":0},"right_cheek_wrinkle_severity":{"value":0},"forehead_wrinkle_info":{"wrinkle_score":6,"wrinkle_severity_level":1,"wrinkle_norm_length":0.6203718537157832,"wrinkle_norm_depth":0.3213379469434833,"wrinkle_pixel_density":0.0013900896759754834,"wrinkle_area_ratio":0.0016620812718950114,"wrinkle_deep_ratio":0.7411764705882353,"wrinkle_deep_num":2,"wrinkle_shallow_num":1},"left_eye_wrinkle_info":{"wrinkle_score":3,"wrinkle_severity_level":0,"wrinkle_norm_length":0.7058865787567897,"wrinkle_norm_depth":0.15074971164936563,"wrinkle_pixel_density":0.1893086963285888,"wrinkle_area_ratio":0.02107142857142857,"wrinkle_deep_ratio":0.7647058823529411,"wrinkle_deep_num":2,"wrinkle_shallow_num":1},"right_eye_wrinkle_info":{"wrinkle_score":2,"wrinkle_severity_level":0,"wrinkle_norm_length":0.38905357399483576,"wrinkle_norm_depth":0.28297213622291023,"wrinkle_pixel_density":0.0917262511096396,"wrinkle_area_ratio":0.014442700156985872,"wrinkle_deep_ratio":0.9473684210526315,"wrinkle_deep_num":1,"wrinkle_shallow_num":0},"left_crowsfeet_wrinkle_info":{"wrinkle_score":0,"wrinkle_severity_level":0,"wrinkle_norm_length":0,"wrinkle_norm_depth":0,"wrinkle_pixel_density":0,"wrinkle_area_ratio":0,"wrinkle_deep_ratio":0,"wrinkle_deep_num":0,"wrinkle_shallow_num":0},"right_crowsfeet_wrinkle_info":{"wrinkle_score":10,"wrinkle_severity_level":1,"wrinkle_norm_length":0.4095300778893008,"wrinkle_norm_depth":0.3850980392156863,"wrinkle_pixel_density":0.11419395695827471,"wrinkle_area_ratio":0.005941329372447085,"wrinkle_deep_ratio":0,"wrinkle_deep_num":1,"wrinkle_shallow_num":0},"glabella_wrinkle_info":{"wrinkle_score":0,"wrinkle_severity_level":0,"wrinkle_norm_length":0,"wrinkle_norm_depth":0,"wrinkle_pixel_density":0,"wrinkle_area_ratio":0,"wrinkle_deep_ratio":0,"wrinkle_deep_num":0,"wrinkle_shallow_num":0},"left_mouth_wrinkle_info":{"wrinkle_score":0,"wrinkle_severity_level":0,"wrinkle_norm_length":0,"wrinkle_norm_depth":0,"wrinkle_pixel_density":0,"wrinkle_area_ratio":0,"wrinkle_deep_ratio":0,"wrinkle_deep_num":0,"wrinkle_shallow_num":0},"right_mouth_wrinkle_info":{"wrinkle_score":0,"wrinkle_severity_level":0,"wrinkle_norm_length":0,"wrinkle_norm_depth":0,"wrinkle_pixel_density":0,"wrinkle_area_ratio":0,"wrinkle_deep_ratio":0,"wrinkle_deep_num":0,"wrinkle_shallow_num":0},"left_nasolabial_wrinkle_info":{"wrinkle_score":39,"wrinkle_severity_level":2,"wrinkle_norm_length":0.30653668065956347,"wrinkle_norm_depth":0.3918767507002801,"wrinkle_pixel_density":0.07596848984847505,"wrinkle_area_ratio":0.029372937293729372,"wrinkle_deep_ratio":1,"wrinkle_deep_num":1,"wrinkle_shallow_num":0},"right_nasolabial_wrinkle_info":{"wrinkle_score":40,"wrinkle_severity_level":2,"wrinkle_norm_length":0.22625326429634446,"wrinkle_norm_depth":0.3964579380139152,"wrinkle_pixel_density":0.06187112207771704,"wrinkle_area_ratio":0.08812818645302258,"wrinkle_deep_ratio":1,"wrinkle_deep_num":1,"wrinkle_shallow_num":0},"left_cheek_wrinkle_info":{"wrinkle_score":0,"wrinkle_severity_level":0,"wrinkle_norm_length":0,"wrinkle_norm_depth":0,"wrinkle_pixel_density":0,"wrinkle_area_ratio":0,"wrinkle_deep_ratio":0,"wrinkle_deep_num":0,"wrinkle_shallow_num":0},"right_cheek_wrinkle_info":{"wrinkle_score":0,"wrinkle_severity_level":0,"wrinkle_norm_length":0,"wrinkle_norm_depth":0,"wrinkle_pixel_density":0,"wrinkle_area_ratio":0,"wrinkle_deep_ratio":0,"wrinkle_deep_num":0,"wrinkle_shallow_num":0},"score_info":{"dark_circle_score":80,"skin_type_score":30,"wrinkle_score":92,"oily_intensity_score":49,"pores_score":96,"blackhead_score":98,"acne_score":100,"sensitivity_score":34,"melanin_score":57,"water_score":96,"rough_score":85,"total_score":76,"pores_type_score":{"pores_forehead_score":98,"pores_leftcheek_score":96,"pores_rightcheek_score":95,"pores_jaw_score":96},"dark_circle_type_score":{"left_dark_circle_score":100,"right_dark_circle_score":80}},"left_eye_pouch_rect":{"left":367,"top":260,"width":72,"height":62},"right_eye_pouch_rect":{"left":486,"top":264,"width":73,"height":64},"melasma":{"value":1,"confidence":0.6541817},"freckle":{"value":0,"confidence":0.19874564},"image_quality":{"face_rect":{"left":328,"top":129,"width":277,"height":405},"face_ratio":0.14032118,"hair_occlusion":0.24035399,"face_orientation":{"yaw":-5.3417883,"pitch":0.684838,"roll":-0.2232403},"glasses":0},"sensitivity_type_v1":0},"face_rectangle":{"top":218,"left":312,"width":300,"height":300},"error_code":0,"log_id":"563414"}';

let scoreJson = ""

const updateScoreJson = (s, delim) => {
    if (!delim) {
        delim = ",";
    } else if (delim === "no_delim") {
        delim = "";
    }
    const arr = s.split(/:/i);
    if (arr.length === 1) {
        scoreJson += `${s}${delim}`;
    } else {
        scoreJson += `"${arr[0]}":${arr[1]}${delim}`;
    }
}

const gradeScore = (x, input, output) => {
    for (let i = 0; i < input.length; i++) {
        if (x <= input[i]) {
            return output[i];
        }
    }
}

const buildSymptomListForJson = sympList => {
    let s = "[";
    sympList.forEach ((symp, index) => {
        s += `"${symp}"`;
        if (index < sympList.length - 1) {
            s += ",";
        }
    })
    s += "]";
    return s;
}

const calcScore = (res, userInfo) => {
     
    // debug:
    if (!res) {
        res = resTest;
        userInfo = {};
        userInfo.symptoms = ['symp1', 'symp2', 'symp3'];
        userInfo.age = 42;
        userInfo.other = "testing123"
    }
    //====================================

    const symptoms = userInfo.symptoms.length;

    scoreJson = "{";

    updateScoreJson (`symptoms: ${buildSymptomListForJson(userInfo.symptoms)}`);
    updateScoreJson (`age: ${userInfo.age}`);
    updateScoreJson (`other: "${userInfo.other}"`);

    const jres_wrapper = (JSON.parse (res));
    const jres = jres_wrapper.result;

    const info = jres.score_info

    let water = info.water_score;
    updateScoreJson (`water: ${water}`)

    let pores = info.pores_score;
    updateScoreJson (`pores: ${pores}`);

    let melanin = info.melanin_score;
    updateScoreJson (`melanin: ${melanin}`);

    let dark_circle = info.dark_circle_score;
    updateScoreJson (`dark_circle: ${dark_circle}`);

    let sensitivity = info.sensitivity_score
    updateScoreJson (`sensitivity: ${sensitivity}`);

    let eye_pouch_val = jres.eye_pouch.value;
    let eye_pouch_conf = jres.eye_pouch.confidence;
    updateScoreJson (`eye_pouch_val: ${eye_pouch_val}`);
    updateScoreJson (`eye_pouch_conf: ${eye_pouch_conf}`);

    let skin_type_val = jres.skin_type.skin_type;
    let skin_type_conf = jres.skin_type.details[1].confidence;
    updateScoreJson (`skin_type_val: ${skin_type_val}`);
    updateScoreJson (`skin_type_conf: ${skin_type_conf}`);

    const water_score = gradeScore (water, [20, 70, 100], [10, 5, 0]);
    const pore_score = gradeScore (pores, [30, 70, 100], [0, 5, 10]);
    const melanin_score = gradeScore (melanin, [30, 75, 100], [0, 5, 10]);
    const dark_circle_score = gradeScore (dark_circle, [40, 100], [0, 10])
    const sensitivity_score = gradeScore (sensitivity, [50, 80, 100], [0, 5, 10])
    const eye_pouch_score = eye_pouch_val == 1 && eye_pouch_conf > 0.1 ? 10 : 0;
    const skin_type_score = skin_type_val == 1 && skin_type_conf > 0.2 ? 10 : 0;

    const factors = [water_score, pore_score, melanin_score, dark_circle_score, sensitivity_score, eye_pouch_score, skin_type_score];
    const factors_names = ["water_score", "pore_score", "melanin_score", "dark_circle_score", "sensitivity_score", "eye_pouch_score", "skin_type_score"];

    let total_score_relative =    factors.reduce((a, b) => a + b, 0)
    const total_score_empiric = Math.round (total_score_relative / factors.length * 10);

    factors.forEach ((a, i) => updateScoreJson (`${factors_names[i]}: ${a}`));
    updateScoreJson (`total_score_relative: ${total_score_relative}`);
    updateScoreJson (`total_score_empiric: ${total_score_empiric}`);

    let classification = "";

    const age = Number(userInfo.age);

    if (age < 38) {
        classification = "Young";
    } else if (age > 52) {
        classification = "Old";
    } else  {
        switch (symptoms) {
            case 0:
                classification = gradeScore (total_score_relative, [45, 70], ["D", "C"]);
                break;
            case 1:
                classification = gradeScore (total_score_relative, [45, 70], ["D", "C"]);
                break;
            case 2:
                classification = gradeScore (total_score_relative, [30, 40, 70], ["D", "C", "B"]);
                break;
            case 3:
                classification = gradeScore (total_score_relative, [40, 45, 70], ["C", "B", "A"]);
                break;
            default: // 4 and above
                classification = gradeScore (total_score_relative, [15, 45, 70], ["C", "B", "A"]);
                break;
        }
    }

    updateScoreJson (`class: "${classification}"`, "no_delim");
    updateScoreJson ("}", "no_delim");

    return scoreJson;
}


// debug:

// for (let i = 0; i < 50; i++) {
//     let symptoms = Math.floor(Math.random() * 6);
//     let test = Math.floor(Math.random() * 71);

//     updateScoreJson (`symptoms: ${symptoms}` )
//     updateScoreJson (`test: ${test}`);

//     calcScore (res, symptoms, test);


//     updateScoreJson ("====================================================================")
//     updateScoreJson ("++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++")
//     updateScoreJson ("====================================================================")

// }






