const resTest = '{"request_id":"1693721496,55372f43-e6ec-4f5a-a479-0a52e6ec9cf4","result":{"skin_age":{"value":40},"eye_pouch":{"value":0,"confidence":0.91217655},"dark_circle":{"value":1,"confidence":1},"dark_circle_severity":{"value":1,"confidence":1},"forehead_wrinkle":{"value":1,"confidence":0.5884062},"crows_feet":{"value":1,"confidence":0.60021275},"eye_finelines":{"value":1,"confidence":0.9905672},"eye_finelines_severity":{"value":2,"confidence":0.9574011},"glabella_wrinkle":{"value":0,"confidence":0.85026157},"nasolabial_fold":{"value":1,"confidence":0.7865813},"nasolabial_fold_severity":{"value":0,"confidence":0.29996118},"skin_type":{"skin_type":3,"details":[{"value":0,"confidence":0.11230756},{"value":0,"confidence":0.030639729},{"value":0,"confidence":0.05881041},{"value":1,"confidence":0.7982423}]},"pores_forehead":{"value":0,"confidence":1},"pores_left_cheek":{"value":0,"confidence":1},"pores_right_cheek":{"value":0,"confidence":1},"pores_jaw":{"value":0,"confidence":1},"blackhead":{"value":0,"confidence":1},"skintone_ita":{"ITA":19.115444,"skintone":4},"skin_hue_ha":{"HA":41.017246,"skin_hue":2},"acne":{"rectangle":[],"confidence":[],"polygon":[]},"mole":{"rectangle":[{"left":514,"top":209,"width":6,"height":6},{"left":493,"top":388,"width":6,"height":7}],"confidence":[0.56373495,0.4206039],"polygon":[[],[{"x":498,"y":394},{"x":495,"y":394},{"x":495,"y":389}]]},"brown_spot":{"rectangle":[{"left":635,"top":384,"width":5,"height":7},{"left":576,"top":482,"width":8,"height":7},{"left":464,"top":429,"width":8,"height":11},{"left":408,"top":442,"width":7,"height":7},{"left":586,"top":210,"width":7,"height":6},{"left":629,"top":221,"width":5,"height":6},{"left":517,"top":284,"width":7,"height":7},{"left":630,"top":294,"width":7,"height":7},{"left":436,"top":329,"width":5,"height":6},{"left":617,"top":412,"width":6,"height":6},{"left":607,"top":218,"width":6,"height":5},{"left":643,"top":249,"width":10,"height":13},{"left":409,"top":457,"width":4,"height":4},{"left":438,"top":492,"width":9,"height":7},{"left":602,"top":507,"width":4,"height":6},{"left":540,"top":517,"width":7,"height":8}],"confidence":[0.61370355,0.47923335,0.47135276,0.44243547,0.4362281,0.3817367,0.3732665,0.36589915,0.35548627,0.34873855,0.33511305,0.33008078,0.316771,0.31501698,0.3116364,0.3031604],"polygon":[[],[{"x":582,"y":487},{"x":577,"y":484},{"x":581,"y":483}],[{"x":468,"y":437},{"x":465,"y":435},{"x":466,"y":430},{"x":470,"y":429}],[{"x":411,"y":448},{"x":408,"y":442},{"x":413,"y":444}],[{"x":592,"y":215},{"x":587,"y":212},{"x":591,"y":211}],[{"x":633,"y":224},{"x":629,"y":221},{"x":633,"y":221}],[{"x":523,"y":290},{"x":517,"y":290},{"x":517,"y":287},{"x":521,"y":286}],[{"x":636,"y":298},{"x":633,"y":300},{"x":631,"y":296}],[],[{"x":622,"y":417},{"x":618,"y":414},{"x":620,"y":412}],[],[{"x":650,"y":260},{"x":644,"y":256},{"x":648,"y":250},{"x":651,"y":253}],[],[{"x":446,"y":496},{"x":440,"y":497},{"x":438,"y":494}],[],[{"x":545,"y":524},{"x":542,"y":522},{"x":543,"y":518},{"x":546,"y":519}]]},"closed_comedones":{"rectangle":[],"confidence":[],"polygon":[]},"acne_mark":{"rectangle":[],"confidence":[],"polygon":[]},"acne_nodule":{"rectangle":[],"confidence":[],"polygon":[]},"acne_pustule":{"rectangle":[],"confidence":[],"polygon":[]},"blackhead_count":11,"skintone":{"value":1,"confidence":0.4685098},"fine_line":{"forehead_count":0,"left_undereye_count":2,"right_undereye_count":3,"left_cheek_count":0,"right_cheek_count":0,"left_crowsfeet_count":0,"right_crowsfeet_count":0,"glabella_count":0},"wrinkle_count":{"forehead_count":0,"left_undereye_count":1,"right_undereye_count":1,"left_mouth_count":0,"right_mouth_count":0,"left_nasolabial_count":1,"right_nasolabial_count":1,"glabella_count":0,"left_cheek_count":0,"right_cheek_count":0,"left_crowsfeet_count":1,"right_crowsfeet_count":1},"oily_intensity":{"t_zone":{"area":0.17,"intensity":1},"left_cheek":{"area":0.38,"intensity":2},"right_cheek":{"area":0.12,"intensity":0},"chin_area":{"area":0.64,"intensity":2},"full_face":{"area":0.28,"intensity":2}},"enlarged_pore_count":{"forehead_count":26,"left_cheek_count":8,"right_cheek_count":11,"chin_count":29},"right_dark_circle_rete":{"value":0},"left_dark_circle_rete":{"value":0},"right_dark_circle_pigment":{"value":2},"left_dark_circle_pigment":{"value":2},"right_dark_circle_structural":{"value":0},"left_dark_circle_structural":{"value":1},"dark_circle_mark":{"left_eye_rect":{"left":418,"top":279,"width":79,"height":69},"right_eye_rect":{"left":549,"top":279,"width":82,"height":72}},"water":{"water_severity":40,"water_area":0.312,"water_forehead":{"area":0.14},"water_leftcheek":{"area":0.568},"water_rightcheek":{"area":0.352}},"rough":{"rough_severity":12,"rough_area":0.165,"rough_forehead":{"area":0.151},"rough_leftcheek":{"area":0.211},"rough_rightcheek":{"area":0.102},"rough_jaw":{"area":0.238}},"left_mouth_wrinkle_severity":{"value":0},"right_mouth_wrinkle_severity":{"value":0},"forehead_wrinkle_severity":{"value":0},"left_crows_feet_severity":{"value":1},"right_crows_feet_severity":{"value":0},"left_eye_finelines_severity":{"value":0},"right_eye_finelines_severity":{"value":0},"glabella_wrinkle_severity":{"value":0},"left_nasolabial_fold_severity":{"value":1},"right_nasolabial_fold_severity":{"value":2},"left_cheek_wrinkle_severity":{"value":0},"right_cheek_wrinkle_severity":{"value":0},"forehead_wrinkle_info":{"wrinkle_score":0,"wrinkle_severity_level":0,"wrinkle_norm_length":0,"wrinkle_norm_depth":0,"wrinkle_pixel_density":0,"wrinkle_area_ratio":0,"wrinkle_deep_ratio":0,"wrinkle_deep_num":0,"wrinkle_shallow_num":0},"left_eye_wrinkle_info":{"wrinkle_score":3,"wrinkle_severity_level":0,"wrinkle_norm_length":0.8090199468098936,"wrinkle_norm_depth":0.14956680346557227,"wrinkle_pixel_density":0.23467155982111595,"wrinkle_area_ratio":0.03964150293002413,"wrinkle_deep_ratio":0.27906976744186046,"wrinkle_deep_num":1,"wrinkle_shallow_num":2},"right_eye_wrinkle_info":{"wrinkle_score":4,"wrinkle_severity_level":0,"wrinkle_norm_length":0.9018574629445801,"wrinkle_norm_depth":0.1680672268907563,"wrinkle_pixel_density":0.20820412523819884,"wrinkle_area_ratio":0.02112482853223594,"wrinkle_deep_ratio":0.1836734693877551,"wrinkle_deep_num":1,"wrinkle_shallow_num":3},"left_crowsfeet_wrinkle_info":{"wrinkle_score":8,"wrinkle_severity_level":1,"wrinkle_norm_length":0.3762883473534389,"wrinkle_norm_depth":0.17137254901960786,"wrinkle_pixel_density":0.16056941248197024,"wrinkle_area_ratio":0.015720081135902637,"wrinkle_deep_ratio":0,"wrinkle_deep_num":1,"wrinkle_shallow_num":0},"right_crowsfeet_wrinkle_info":{"wrinkle_score":0,"wrinkle_severity_level":0,"wrinkle_norm_length":0,"wrinkle_norm_depth":0,"wrinkle_pixel_density":0,"wrinkle_area_ratio":0,"wrinkle_deep_ratio":0,"wrinkle_deep_num":0,"wrinkle_shallow_num":0},"glabella_wrinkle_info":{"wrinkle_score":0,"wrinkle_severity_level":0,"wrinkle_norm_length":0,"wrinkle_norm_depth":0,"wrinkle_pixel_density":0,"wrinkle_area_ratio":0,"wrinkle_deep_ratio":0,"wrinkle_deep_num":0,"wrinkle_shallow_num":0},"left_mouth_wrinkle_info":{"wrinkle_score":0,"wrinkle_severity_level":0,"wrinkle_norm_length":0,"wrinkle_norm_depth":0,"wrinkle_pixel_density":0,"wrinkle_area_ratio":0,"wrinkle_deep_ratio":0,"wrinkle_deep_num":0,"wrinkle_shallow_num":0},"right_mouth_wrinkle_info":{"wrinkle_score":0,"wrinkle_severity_level":0,"wrinkle_norm_length":0,"wrinkle_norm_depth":0,"wrinkle_pixel_density":0,"wrinkle_area_ratio":0,"wrinkle_deep_ratio":0,"wrinkle_deep_num":0,"wrinkle_shallow_num":0},"left_nasolabial_wrinkle_info":{"wrinkle_score":24,"wrinkle_severity_level":1,"wrinkle_norm_length":0.26199265296902313,"wrinkle_norm_depth":0.2436532507739938,"wrinkle_pixel_density":0.06540023659059724,"wrinkle_area_ratio":0.12221892613467814,"wrinkle_deep_ratio":1,"wrinkle_deep_num":1,"wrinkle_shallow_num":0},"right_nasolabial_wrinkle_info":{"wrinkle_score":27,"wrinkle_severity_level":2,"wrinkle_norm_length":0.2413090224714687,"wrinkle_norm_depth":0.27372549019607845,"wrinkle_pixel_density":0.06339654365267443,"wrinkle_area_ratio":0.008117389946924758,"wrinkle_deep_ratio":1,"wrinkle_deep_num":1,"wrinkle_shallow_num":0},"left_cheek_wrinkle_info":{"wrinkle_score":0,"wrinkle_severity_level":0,"wrinkle_norm_length":0,"wrinkle_norm_depth":0,"wrinkle_pixel_density":0,"wrinkle_area_ratio":0,"wrinkle_deep_ratio":0,"wrinkle_deep_num":0,"wrinkle_shallow_num":0},"right_cheek_wrinkle_info":{"wrinkle_score":0,"wrinkle_severity_level":0,"wrinkle_norm_length":0,"wrinkle_norm_depth":0,"wrinkle_pixel_density":0,"wrinkle_area_ratio":0,"wrinkle_deep_ratio":0,"wrinkle_deep_num":0,"wrinkle_shallow_num":0},"score_info":{"dark_circle_score":67,"skin_type_score":46,"wrinkle_score":94,"oily_intensity_score":49,"pores_score":97,"blackhead_score":97,"acne_score":100,"sensitivity_score":30,"melanin_score":90,"water_score":60,"rough_score":88,"total_score":77,"pores_type_score":{"pores_forehead_score":97,"pores_leftcheek_score":98,"pores_rightcheek_score":98,"pores_jaw_score":95},"dark_circle_type_score":{"left_dark_circle_score":78,"right_dark_circle_score":89}},"left_eye_pouch_rect":{"left":418,"top":279,"width":79,"height":69},"right_eye_pouch_rect":{"left":549,"top":279,"width":82,"height":72},"melasma":{"value":0,"confidence":0.41112977},"freckle":{"value":0,"confidence":0.16856176},"image_quality":{"face_rect":{"left":380,"top":130,"width":299,"height":441},"face_ratio":0.16114584,"hair_occlusion":0.2639208,"face_orientation":{"yaw":-9.4523,"pitch":-6.4089923,"roll":-4.718456},"glasses":0},"sensitivity_type_v1":0},"face_rectangle":{"top":233,"left":362,"width":335,"height":335},"error_code":0,"log_id":"664949"}';

let scoreJson = ""

const updateScoreJson = (s, delim) => {
    if (!delim) {
        delim = ",";
    } else if (delim === "no_delim") {
        delim = "";
    }
    const arr = s.split(/:/i);
    if (arr.length === 1) {
        scoreJson += `${s}${delim}`;
    } else {
        scoreJson += `"${arr[0]}":${arr[1]}${delim}`;
    }
}

const gradeScore = (x, input, output) => {
    for (let i = 0; i < input.length; i++) {
        if (x < input[i]) {
            return output[i];
        }
    }
}

const buildSymptomListForJson = sympList => {
    let s = "[";
    sympList.forEach ((symp, index) => {
        s += `"${symp}"`;
        if (index < sympList.length - 1) {
            s += ",";
        }
    })
    s += "]";
    return s;
}

const calcScore = (res, userInfo) => {
     
    // debug:
    if (!res) {
        res = resTest;
        userInfo = {};
        userInfo.symptoms = ['symp1', 'symp2', 'symp3'];
        userInfo.age = 21;
        userInfo.other = "testing123"
    }
    //====================================

    const symptoms = userInfo.symptoms.length;

    scoreJson = "{";

    updateScoreJson (`symptoms: ${buildSymptomListForJson(userInfo.symptoms)}`);
    updateScoreJson (`age: ${userInfo.age}`);
    updateScoreJson (`other: "${userInfo.other}"`);

    const jres_wrapper = (JSON.parse (res));
    const jres = jres_wrapper.result;

    const info = jres.score_info

    let water = info.water_score;
    updateScoreJson (`water: ${water}`)

    let pores = info.pores_score;
    updateScoreJson (`pores: ${pores}`);

    let melanin = info.melanin_score;
    updateScoreJson (`melanin: ${melanin}`);

    let dark_circle = info.dark_circle_score;
    updateScoreJson (`dark_circle: ${dark_circle}`);

    let sensitivity = info.sensitivity_score
    updateScoreJson (`sensitivity: ${sensitivity}`);

    let eye_pouch_val = jres.eye_pouch.value;
    let eye_pouch_conf = jres.eye_pouch.confidence;
    updateScoreJson (`eye_pouch_val: ${eye_pouch_val}`);
    updateScoreJson (`eye_pouch_conf: ${eye_pouch_conf}`);

    let skin_type_val = jres.skin_type.skin_type;
    let skin_type_conf = jres.skin_type.details[1].confidence;
    updateScoreJson (`skin_type_val: ${skin_type_val}`);
    updateScoreJson (`skin_type_conf: ${skin_type_conf}`);

    const water_score = gradeScore (water, [30, 50, 70, 100], ['error', 10, 5, 0]);
    const pore_score = gradeScore(pores, [30, 50, 70, 100], ['error', 10, 5, 0]);
    const melanin_score = gradeScore(melanin, [30, 50, 70, 100], ['error', 10, 5, 0]);
    const dark_circle_score = gradeScore(dark_circle, [30, 50, 70, 100], ['error', 10, 5, 0])
    const sensitivity_score = gradeScore(sensitivity, [30, 50, 70, 100], ['error', 10, 5, 0])
    const eye_pouch_score = eye_pouch_val == 1 && eye_pouch_conf > 0.1 ? 10 : 0;
    const skin_type_score = skin_type_val == 1 && skin_type_conf > 0.2 ? 10 : 0;

    const factors = [water_score, pore_score, melanin_score, dark_circle_score, sensitivity_score, eye_pouch_score, skin_type_score];
    const factors_names = ["water_score", "pore_score", "melanin_score", "dark_circle_score", "sensitivity_score", "eye_pouch_score", "skin_type_score"];

    let total_score_relative =    factors.reduce((a, b) => a + b, 0)
    const total_score_empiric = Math.round (total_score_relative / factors.length * 10);

    factors.forEach ((a, i) => updateScoreJson (`${factors_names[i]}: ${a}`));
    updateScoreJson (`total_score_relative: ${total_score_relative}`);
    updateScoreJson (`total_score_empiric: ${total_score_empiric}`);

    let classification = "";

    const age = Number(userInfo.age);

    if (age < 38) {
        classification = "Young";
    } else if (age > 52) {
        classification = "Old";
    } else  {
        switch (symptoms) {
            case 0:
                classification = gradeScore (total_score_relative, [45, 70], ["D", "C"]);
                break;
            case 1:
                classification = gradeScore (total_score_relative, [45, 70], ["D", "C"]);
                break;
            case 2:
                classification = gradeScore (total_score_relative, [30, 40, 70], ["D", "C", "B"]);
                break;
            case 3:
                classification = gradeScore (total_score_relative, [40, 45, 70], ["C", "B", "A"]);
                break;
            default: // 4 and above
                classification = gradeScore (total_score_relative, [15, 45, 70], ["C", "B", "A"]);
                break;
        }
    }

    updateScoreJson (`class: "${classification}"`, "no_delim");
    updateScoreJson ("}", "no_delim");

    return scoreJson;
}


// debug:

// for (let i = 0; i < 50; i++) {
//     let symptoms = Math.floor(Math.random() * 6);
//     let test = Math.floor(Math.random() * 71);

//     updateScoreJson (`symptoms: ${symptoms}` )
//     updateScoreJson (`test: ${test}`);

//     calcScore (res, symptoms, test);


//     updateScoreJson ("====================================================================")
//     updateScoreJson ("++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++")
//     updateScoreJson ("====================================================================")

// }






