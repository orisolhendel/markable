<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title></title>
    <style>
        button {
            font-family: 'Merriweather', serif;
            font-size: 18px;
            color: #ffffff;
            border: none;
            border-radius: 20px;
            width: 120px;
            height: 30px;
            box-shadow: 1.41px 1.41px 5px #757575;
            background: rgba(117, 117, 117, 0.96);
            cursor: pointer;
            text-align: center;
        }

        button:hover {
            background-color:#a5dbac;
        }

        th {
            text-align: center;
            border: 1px solid gray;
        }

        td {
            text-align: center;
            border: 1px solid gray;
        } 

        .captionText {
            font-family: 'Merriweather', serif; 
            font-size:16px;
            padding: 10px;
            color:#777777;
            display: inline;
            float: left;
        }

        .abs {
            position: absolute;
        }
    </style>
</head>

<body>

    <%- include('../partials/header'); %>

    <!-- picture div -->
    <div id="picDiv" class="abs" style="z-index: 100; border: 1px solid gray; width:565px; height: 700px; background-color: #eeeeee; display: none;">
        <img id="selfieImg" class="abs" style="width: 480px; height: auto; top: 40px; left: 40px;" width="480" height="auto"/>
        <canvas id="resCanvas" class="abs" width="480" height="auto"></canvas>
        <button id="toggleMarksBtn" class="abs" style="top:5px; left: 5px;;" onclick="toggleMarks(this)">Hide Marks</button>
        <div class="abs hand" style="top:6px; right: 10px; font-size: 27px; font-family: 'Merriweather', serif;" onclick="hidePic()">X</div>
    </div>

    <!-- table div -->
    <div id="tableDiv" class="abs captionText" style="top:120px; left: 10px; width: 500px; table-layout:fixed;">
        <img id="loadingImg" class="abs" style="width:36px; height: 36px; top:80px; left: 500px; display: none;" src="./img/loading.gif" />
        <table id="resTable" style="width:1300px; border: 1px solid gray;">
            <tr>
                <th>id</th>
                <!--th style="width:120px;">uid</th-->
                <th>date-time</th>
                <th>selfie</th>
                <th style="width:120px;">image dimentions</th>
                <th style="width:180px;">device</th>
                <th style="width:180px;">mobile / desktop</th>
                <th style="width:150px;">results</th>
                <th style="width:120px;">score</th>
            </tr>
        </table>
    </div>

    <script>

        $$("loadingImg").style.display = "";

        fetch('/show_db', {
            method: 'GET'
        })
        .then(response => response.text())
        .then(result => {
            renderTable (result);
        })
        .catch(error => {
            $$("loadingImg").style.display = "none";
            console.error(error);
        });

        const getDeviceType = json => {
            try {
                return JSON.parse(json).summary
            } catch (e) 
            {   
                return '';
            }
        }

        const renderTable = res => {

            $$("loadingImg").style.display = "none";
            const table = $$("resTable");
            let trs = "";

            const rows = Array.from (JSON.parse(res).rows);

            rows.forEach (row => {
                trs += `
                    <tr>
                        <td>${row.id}</td>
                        <!--td>${row.uid}</td-->
                        <td>${row.dt}</td>
                        <td><a href="javascript:void(0);" onclick='showPic("${row.uid}", this.parentElement, ${row.results}, ${row.selfiesdim})'>show picture</a></td>
                        <td>${row.selfiesdim}</td>
                        <td>${row.device}</td>
                        <td>${getDeviceType(row.device)}</td>
                        <td style="overflow:hidden; white-space: nowrap; max-height:100px; max-width:150px; text-align:left;">${row.results}</td>
                        <td style="overflow:hidden; white-space: nowrap; max-height:100px; max-width:150px; text-align:left;">${row.score}</td>
                    </tr>
                `;
            })

            table.innerHTML += trs;
        }

        const showPic = (uid, container, res, dim) => {

            const widthFactor = dim.width / 480;
            const heightFactor = widthFactor;

            $$("resCanvas").height = dim.height / widthFactor

            // show loading sign:
            const loading = $$("loadingImg");
            loading.style.display = "";
            loading.style.left = (container.getBoundingClientRect().left - 285) + "px";
            loading.style.top = (container.getBoundingClientRect().top - 110) + "px";

            // fetch data:
            fetch(`/show_pic?uid=${uid}`, {
                method: 'GET'
            })
            .then(response => response.text())
            .then(result => {
                console.log(result);
                const selfieImg = $$("selfieImg");
                const picDiv = $$("picDiv");
                selfieImg.src = `./tmp/${result}`;

                picDiv.style.left = container.getBoundingClientRect().left + "px";
                picDiv.style.top = (container.getBoundingClientRect().top + 40) + "px";
                picDiv.style.display = "";

                const resJson = res;
                const resCanvas = $$("resCanvas");
                const ctx = resCanvas.getContext("2d");

                ctx.clearRect(0, 0, resCanvas.width, resCanvas.height);

                resCanvas.style.left = selfieImg.style.left;
                resCanvas.style.top = selfieImg.style.top;

                resCanvas.style.display = "";
                $$("toggleMarksBtn").innerText = "Hide Marks";

                Array.from (resJson.result.brown_spot.rectangle).forEach(element => {
                    
                    ctx.beginPath();
                    ctx.ellipse(element.left / widthFactor, 
                                element.top / heightFactor, 
                                element.width / widthFactor, 
                                element.height / heightFactor, 
                                0, 
                                2 * Math.PI, 
                                false);
                    ctx.fillStyle = "green";
                    ctx.fill();
                    ctx.closePath();
                });

                // hide loading sign:
                loading.style.display = "none";
            })
            .catch(error => {
                console.error(error);

                // hide loading sign:
                loading.style.display = "none";
            });
        }

        const hidePic = () => {
            $$("picDiv").style.display = "none";
        }

        const toggleMarks = button => {
            const resCanvas = $$("resCanvas");
            resCanvas.style.display = (resCanvas.style.display === "none") ? "" : "none";
            button.innerText = (resCanvas.style.display === "none") ? "Show Marks" : "Hide Marks";
        }

    </script>


</body>
</html>





