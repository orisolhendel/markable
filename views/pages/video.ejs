<!DOCTYPE html>
<html>
<head>
    <meta content='width=device-width; initial-scale=0.75; maximum-scale=0.75; user-scalable=yes;' name='viewport' />
    <title></title>
    <style>

        #sendPicFinal {
            background-color: #712337;
        }

        #sendPicFinal:hover {
            background-color:#a5dbac;
        }

        #letsGetStarted {
            background-color: #861331;
        }

        #letsGetStarted:hover {
            background-color:#a5dbac;
        }

        .checkTd {
            vertical-align: top;
            cursor: pointer;
            color: #777777;
            width: 130px;
            height: 90px;
        }

        @media only screen and (min-width: 1000px) { /* web only */
            body.bgImage {
                background-image: url('../img/bg.png');
            }
        }

        @media only screen and (max-width: 1000px) {
            img.clipLocationMobile {
                left: 5%;
                width:93%;
                top:90px;
            }
        }

        @media only screen and (min-width: 1000px) {
            img.clipLocationWeb {
                right: 100px;
                top:200px;
                width: 440px;
            }
        }

        @media only screen and (max-width: 1000px) {
            div.introTextLocationMobile {
                left:5%;
                top: 62%;
            }
        }

        @media only screen and (min-width: 1000px) {
            div.introTextLocationWeb {
                left: 100px; 
                top: 170px;
            }
        }

        @media only screen and (max-width: 1000px) {
            button.buttonLayoutMobile {
                bottom:1%;
                left: 3%;
                width:95%;
                height: 5%
            }
        }

        @media only screen and (min-width: 1000px) {
            button.buttonLayoutWeb {
                left: 100px; 
                top: 670px;  
                width:300px; 
                height: 50px; 
            }
        }

        @media only screen and (max-width: 1000px) {
            div.mediaLocationMobile {
                left: 5%;
                top:90px;
            }
        }

        @media only screen and (min-width: 1000px) {
            div.mediaLocationWeb {
                right: 160px; 
                top:115px; 
            }
        }
    </style>

    <script src="./scripts/score.js"></script>
    <script src="./scripts/mark_checkboxes.js"></script>

    <script>
        const getStarted = () => {
            $$("introDiv").style.display = "none";
            $$("vidDiv").style.display = "";
            $$("leftDiv").style.display = "";
            document.body.classList.remove("bgImage");
            console.log (document.body.style.backgroundImage);
        }

        const showCanvas = show => {
            $$("canvasElement").style.display = show ? "" : "none";
            $$("videoElement").style.display = show ? "none" : "";
            $$("capture").style.display = show ? "none" : "";
            $$("reCapture").style.display = show ? "" : "none";
            $$("sendPic").style.display = show ? "" : "none";
        }

        const showCheckboxes = () => {
            $$("mediaDiv").style.display = "none";
            $$("leftDiv").style.display = "none";
            $$("vidDiv").style.display = "none";
            $$("checkDiv").style.display = "";
        }

        const showResults = (res) => {
            try {
                $$("resDiv").innerHTML = calctScore (res, getCheckCount());
            } catch (e) {
                alert (e)
                $$("resDiv").innerHTML = e;
            }

            $$("resDiv").style.display = "";
            $$("vidDiv").style.display = "";
            $$("vidDiv").style.left = "220px";
            $$("vidDiv").style.border = "none";
            $$("mediaDiv").style.display = "";
            $$("canvasElement").style.display = "";
            $$("videoElement").style.display = "none";
            $$("checkDiv").style.display = "none";
            $$("leftDiv").style.display = "none";
            $$("reCapture").style.display = "none";
            $$("sendPic").style.display = "none";

            //alert (calctScore (res, getCheckCount()));
            //$$("resCanvas").style.display = "";

            //$$("resCanvas").style.left = $$("canvasElement").style.left;
            //$$("resCanvas").style.top = $$("canvasElement").style.top;

            // $$("canvasElement").width = "512";
            // $$("canvasElement").height = "512";

            //$$("canvasElement").getContext('2d').drawImage($$("canvasElementToSend"), 0, 0, 512, 512);

            // const resJson = JSON.parse (res);
            // const resCanvas = $$("resCanvas");
            // const ctx = resCanvas.getContext("2d");

            // Array.from (resJson.result.brown_spot.rectangle).forEach(element => {
                
            //     ctx.beginPath();
            //     ctx.ellipse(element.left / 8, element.top / 8, element.width / 8, element.height / 8, 0, 2 * Math.PI, false);
            //     ctx.fillStyle = "green";
            //     ctx.fill();
            //     ctx.closePath();
            // });
        }

        const generateDimJson = () => {
            return `{"width" : ${canvasToSend.width}, "height" : ${canvasToSend.height}}`;
        }

        const clearNoSymp = (check) => {
            if (check.checked) {
                $$("no_symp").checked = false;
                animateCb (mark_cb_get_outer_from_cb ($$("no_symp")), $$("no_symp"));
            }

            toggleAnalyzeDisableness ();
        }

        const clearChecks = () => {
            const checks = document.querySelectorAll('input[type="checkbox"]:checked');
            checks.forEach (check => {
                if (check.id != 'no_symp') {
                    check.checked = false;
                    animateCb (mark_cb_get_outer_from_cb (check), check);
                }
            });

            toggleAnalyzeDisableness ();
        }

        const getCheckCount = () => {
            const checks = document.querySelectorAll('input[type="checkbox"]:checked');
            let count = 0;
            checks.forEach (check => {
                if (check.id === 'no_symp') {
                    return 0;
                } else {
                    count++;
                }
            });
            return count;
        }

        const toggleAnalyzeDisableness = () => {
            const checks = document.querySelectorAll('input[type="checkbox"]:checked');
            const disdiv = $$("disableAnalyze");
            disdiv.style.display = checks.length ? "none" : "";
        }
    </script>
</head>

<body class="bgImage">

    <%- include('../partials/header'); %>

    <!-- indroduction: -->
    <div id="introDiv">
        <div class="abs introTextLocationMobile introTextLocationWeb" style="font-family: 'Lora';">
            <div style="font-size: 36px; line-height: 48px; max-width: 600px;">
                Are you feeling out of whack? Like everything that used to come so easy is suddenly a struggle? 
            </div>

            <div style="font-size: 32px;font-weight: 100; font-family: 'Quattrocento'; line-height: 33px; max-width: 600px;">
                <br /><br />
                Brain fog, extreme fatigue and even depression are just a few of
                the many troubling symptoms of perimenopause
            </div>

            <div style="font-size: 24px; font-weight: 900; font-family: 'Quattrocento'; line-height: 33px; max-width: 600px;">
                <br /><br />
                Take a selfie and instantly receive your perimenopause assessment.
                <br /><br /><br /><br /><br /><br />
            </div>
        </div>
        <img class="abs letsGetStarted clipLocationMobile clipLocationWeb" height="auto" src="../img/clip.gif"/>
        <button id="letsGetStarted" class="fxd buttonLayoutMobile buttonLayoutWeb" style="font-size: 32px;" onclick="getStarted()">Let's Get Started!</button>
    </div>

    <!-- video and canvas -->
    <div id="vidDiv" class="abs mediaLocationMobile mediaLocationWeb" style="width:550px; height: 600px; display: none;">
  
        <div id="mediaDiv">
            <div id="videoWrapper" class="abs" style="left:38px; top: 30px; margin: 0px; padding: 0px;">
                <video  id="videoElement" autoplay="true" loop="true" muted="true" playsinline="true" width="480" height="auto" style="background-color: #ffffff; transform: scale(-1, 1); -webkit-transform: scale(-1, 1); -moz-transform: scale(-1, 1);" ></video>
            </div>
            <canvas id="canvasElement" width="480" class="abs" style="top:30px; left: 38px; transform: scale(-1, 1); -webkit-transform: scale(-1, 1); -moz-transform: scale(-1, 1)"></canvas>
            <canvas id="canvasElementToSend" width="4096" style="display:none; transform: scale(-1, 1); -webkit-transform: scale(-1, 1); -moz-transform: scale(-1, 1)"></canvas>
            <button class="abs" id="reCapture" style="top:420px; left:60px; display: none;"><span style="font-size: 21px;"> &lt;</span> &nbsp; &nbsp; Retake Selfie</button>
            <button class="abs" id="sendPic" style="top:420px; left:300px; display: none;" onclick="showCheckboxes()">âœ“ &nbsp; Analyze My Selfie</button>

            <canvas  id="placeHolderCanvas"  width="480" class="abs" style="top:30px; left: 38px; z-index: 100;"></canvas>

            <div id="captureWrapper" class="abs" style="width:480px; height: 75px; background-color: rgba(0, 0, 0, 0.5);"></div>
            <div id="capture" class="abs hand" style="width: 46px; height: 46px; background-color: #f4ebe5; border-radius: 50px; border: 8px double white; z-index: 400;"></div>
            <!--canvas id="resCanvas" class="abs" width="512" height="512" style="display: none;"></canvas-->
        </div>
    </div>

    <!-- checkbox div -->
    <div id="checkDiv" class="abs" style="top:165px; left:410px; width: 100%; border:5px solid #fdfaf6; border-radius: 10px; width:920px; height: 600px;; display: none;">
        <div class="abs" style='top:30px; left:20px; font-size: 30px; font-family: "Lora"; text-align: center; width: 100%; color:#777777; border: 1px solid #ffffff;'>
            While We Analyze Your Biomarkers, <br />
            Please Check All That Applies To You
        </div>
        <table class="abs" style='left: 30px; top:120px; font-size: 18px; font-family: "Quattrocento"; width: 92%; vertical-align: top; '>
            <tr>
                <td class="checkTd"><%- include('../partials/mark_checkbox', {cb: "cb1", onclick: "clearNoSymp"}); %></td>
                <td class="checkTd" onclick="$$('cb1_outer').click();">New onset heavy and/or longer flow</td>
                <td class="checkTd"><%- include('../partials/mark_checkbox', {cb: "cb2", onclick: "clearNoSymp"}); %></td>
                <td class="checkTd" onclick="$$('cb2_outer').click();">Shorter menstrual cycles (up to 25 days)</td>
                <td class="checkTd"><%- include('../partials/mark_checkbox', {cb: "cb3", onclick: "clearNoSymp"}); %></td>
                <td class="checkTd" onclick="$$('cb3_outer').click();">New sore, swollen or lumpy breasts</td>
            </tr>
            <tr>
                <td class="checkTd"><%- include('../partials/mark_checkbox', {cb: "cb4", onclick: "clearNoSymp"}); %></td>
                <td class="checkTd" onclick="$$('cb4_outer').click();">New mid-sleep wakening</td>
                <td class="checkTd"><%- include('../partials/mark_checkbox', {cb: "cb5", onclick: "clearNoSymp"}); %></td>
                <td class="checkTd" onclick="$$('cb5_outer').click();">New or markedly increased migrane headaches</td>
                <td class="checkTd"><%- include('../partials/mark_checkbox', {cb: "cb6", onclick: "clearNoSymp"}); %></td>
                <td class="checkTd" onclick="$$('cb6_outer').click();">Increased cramps</td>
            </tr>
            <tr>
                <td class="checkTd"><%- include('../partials/mark_checkbox', {cb: "cb7", onclick: "clearNoSymp"}); %></td>
                <td class="checkTd" onclick="$$('cb7_outer').click();">Onset of night sweats, in particular premenstraully</td>
                <td class="checkTd"><%- include('../partials/mark_checkbox', {cb: "cb8", onclick: "clearNoSymp"}); %></td>
                <td class="checkTd" onclick="$$('cb8_outer').click();">New/increased premenstrual mood swings</td>
                <td class="checkTd"><%- include('../partials/mark_checkbox', {cb: "cb9", onclick: "clearNoSymp"}); %></td>
                <td class="checkTd" onclick="$$('cb9_outer').click();">Weight gain without changes in exercise or eating</td>
            </tr>
            <tr>
                <td class="checkTd"><%- include('../partials/mark_checkbox', {cb: "cb10", onclick: "clearNoSymp"}); %></td>
                <td class="checkTd" onclick="$$('cb10_outer').click();">Other</td>
                <td class="checkTd"><%- include('../partials/mark_checkbox', {cb: "no_symp", onclick: "clearChecks"}); %></td>
                <td class="checkTd" onclick="$$('no_symp_outer').click();">I don't have any symptoms</td>
                <td></td>
                <td ></td>
            </tr>
        </table>

        <button class="abs" id="sendPicFinal" style="top:480px; left:350px;">Ready For My Results!</button>
        <div class="abs" id="disableAnalyze" style="top:460px; left: 330px; width: 240px; height: 80px; z-index: 100; background-color: rgba(255, 255, 255, 0.5);"></div>
        <img id="loadingImg" class="abs" style="width:36px; height: 36px; top:435px; left: 280px; z-index: 20; display: none;" src="./img/loading.gif" />

    </div>

    <!-- left div -->
    <div id="leftDiv" class="abs" style="top: 150px; left:100px; max-width:400px; display:none;">

        <span style='font-family: "Lora"; font-size: 36px; font-weight: 900; text-align: left; width: 100%;'>
            Analyze Your Biomarkers
            <br /><br />
        </span>
        <span style='font-family: "Quattrocento"; font-size: 32px; text-align: left;'>
            Take a selfie and get your biomarker analysis results instantly 
            <br /><br />
            <a href="javascript:void(0)">Why test my biomarkers</a>
            <br /><br />
        </span>
        <div class="abs" style="    background-color: #f4ebe5; 
                        width: 360px;
                        height: 180px;;
                        padding:10px;">
            <div style="width:100%; height: 100%; border: 1px solid black;">
                <div class="abs" style="left: 0px; top: 14px; font-family: 'Quattrocento'; font-size: 24px; font-weight: 900; padding-left: 0px;">
                    &nbsp; &nbsp; Before You Take Your Picture
                </div>
                <div class="abs" style="left: 0px; top: 40px; font-family: 'Quattrocento'; font-size: 18px;">
                    <img class="abs" style="left: 16px; top: 5px; left: 17px;" src="./img/vsign.png" width="30" height="auto" />
                    <div class="abs" style="left: 45px; top:9px; width: 360px;">Remove your glasses</div>
                </div>
                <div class="abs" style="left: 0px; top: 74px; font-family: 'Quattrocento'; font-size: 18px;">
                    <img class="abs" style="left: 16px; top: 5px; left: 17px;;" src="./img/vsign.png" width="30" height="auto" />
                    <div class="abs" style="left: 45px; top:9px; width: 360px;">Remove your makeup</div>
                </div>
                <div class="abs" style="left: 0px; top: 108px; font-family: 'Quattrocento'; font-size: 18px;">
                    <img class="abs" style="left: 16px; top: 5px; left: 17px;;" src="./img/vsign.png" width="30" height="auto" />
                    <div class="abs" style="left: 45px; top:9px; width: 360px;">Ensure proper lighting</div>
                </div>
                <div class="abs" style="left: 0px; top: 142px; font-family: 'Quattrocento'; font-size: 18px;">
                    <img class="abs" style="left: 16px; top: 5px; left: 17px;;" src="./img/vsign.png" width="30" height="auto" />
                    <div class="abs" style="left: 45px; top:9px; width: 360px;">Face directly at camera</div>
                </div>
                
            </div>
        </div>
    </div>

    <!-- resutls image -->
    <div id="resDiv" style="position:fixed; top:120px; left: 770px; z-index: 1000; width: 100%; height: 100%; overflow: scroll; display: none;">
        <!--img src="img/results.png" class="abs" style="top:0px; left: 0px; max-width:600px; height:auto;" /-->
    </div>

    <script>
        const video = document.querySelector("#videoElement");

        if (navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function (stream) {
                    video.srcObject = stream;
                    const vsettings = (stream.getVideoTracks()[0].getSettings());
                    const vwidht = vsettings.width;
                    const vheight = vsettings.height;
                    const vratio = vwidht / vheight;

                    canvasElement.height = Math.round (canvasElement.width / vratio);
                    canvasToSend.height =  Math.round (canvasToSend.width / vratio);

                    // draw place holder
                    const phCanvas = $$("placeHolderCanvas");
                    const phx = phCanvas.getContext("2d");

                    phCanvas.height =  Math.round (phCanvas.width / vratio);

                    phx.beginPath();
                    phx.ellipse(phCanvas.width / 2, 160, 290 , 320, 0, 2 * Math.PI, false);
                    phx.strokeStyle = "rgba(0,0,0,0.4)";
                    phx.lineWidth = 395;
                    phx.stroke();
                    phx.closePath();

                    $$("captureWrapper").style.left = "38px";
                    $$("captureWrapper").style.top = `${phCanvas.height - 75 + 30}px`;
                    $$("capture").style.left = `${phCanvas.width / 2 - 23 + 34}px`
                    $$("capture").style.top = `${phCanvas.height - 39}px`

                    if (window.innerWidth < 1000) {
                        $$("leftDiv").style.top = `${phCanvas.height + 180}px`;
                    }
            })
                .catch(function (error) {
                    console.log("Something went wrong!");
                    console.log(error);
            });
        }
    </script>


    <form id="uploadForm" enctype="multipart/form-data" style="display: none;">
        <input type="file" name="file" id="fileInput" />
        <input type="text" name="res" id="resInput" />
        <input type="text" name="dim" id="dimInput" />
        <input type="text" name="score" id="scoreInput" />
        <button type="submit" id="uploadButton">Upload</button>
    </form>

    <script>
        const canvas = $$('canvasElement');
        const canvasToSend = $$('canvasElementToSend');
        const captureButton = $$('capture');
        const recaptureButton = $$('reCapture');
        const sendPicButton = $$('sendPicFinal');


        captureButton.addEventListener('click', () => {
            showCanvas (true);
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            canvasToSend.getContext('2d').drawImage(video, 0, 0, canvasToSend.width, canvasToSend.height);
        });

        recaptureButton.addEventListener('click', () => {
            showCanvas (false);
        });

        sendPicButton.addEventListener('click', () => {
            
            canvasToSend.toBlob ( blob => {

                $$("loadingImg").style.display = "";
                $$("disableAnalyze").style.display = "";
                
                const formdata = new FormData();
                formdata.append("image", blob);

                formdata.append("side_image", blob);
                formdata.append("return_maps", "");
                formdata.append("return_marks", "");
                formdata.append("roi_outline_color", "");
                formdata.append("return_side_results", "");

                const file = new File( [ blob ], "mycanvas.jpg" );
                const dT = new DataTransfer();
                dT.items.add( file );
                $$( "fileInput" ).files = dT.files;

                const requestOptions = {
                    method: 'POST',
                    body: formdata,
                    redirect: 'follow',
                    headers: {
                        'ailabapi-api-key': 'VDAp3sCkYwcqEyDES40SXl625sT6QFpc3efjGoHmBTf9QKKhtRvjUVdrmZP8O7Lw'
                    }
                };

                const requestOptionsForSaving = {
                    method: 'POST',
                    body: formdata,
                    redirect: 'follow',
                };

                fetch("https://www.ailabapi.com/api/portrait/analysis/skin-analysis-pro", requestOptions)
                    .then(response => response.text())
                    .then(async (result) => {
                        console.log (result);
                        $$("resInput").value = result;
                        $$("dimInput").value = generateDimJson();
                        showResults (result);
                    })
                    .then(
                        () => {
                            $$('uploadButton').click();
                        }
                    ) 
                    .catch (error => showResults (error));
            
            },"image/jpeg", 1);


            
        });

        $$('uploadForm').addEventListener('submit', (e) => {
            e.preventDefault();

            const fileInput = $$('fileInput');
            const file = fileInput.files[0];

            const res = $$('resInput').value;
            const dim = $$('dimInput').value;

            const formData = new FormData();
            formData.append('file', file);
            formData.append('res', res);
            formData.append('dim', dim);

            fetch('/submit', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(result => {
                $$("loadingImg").style.display = "none";
                alert(result);
            })
            .catch(error => {
                console.error(error);
            });
        });

    </script>


</body>
</html>







